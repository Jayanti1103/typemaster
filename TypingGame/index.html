<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TypeMaster Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Check for user IMMEDIATELY before the page loads
        const savedUser = localStorage.getItem('typeMasterCurrentUser');
        if (!savedUser) {
            // If no user, stop everything and go to login
            window.location.replace('login.html');
        }
    </script>

    <style>
        :root {
            --primary: #6366f1; --primary-dark: #4f46e5; --bg-color: #f8fafc; --text-color: #1e293b;
            --glass-bg: rgba(255, 255, 255, 0.95); --glass-border: rgba(255, 255, 255, 0.5);
            --input-bg: #ffffff; --input-border: #e2e8f0; --gray-text: #64748b;
            --green: #22c55e; --red: #ef4444; --shadow: 0 20px 40px -10px rgba(0,0,0,0.1);
        }
        body.dark-mode {
            --bg-color: #0f172a; --text-color: #f1f5f9; --glass-bg: rgba(30, 41, 59, 0.95);
            --glass-border: rgba(255, 255, 255, 0.1); --input-bg: #1e293b; --input-border: #334155;
            --gray-text: #94a3b8; --shadow: 0 20px 40px -10px rgba(0,0,0,0.5);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            background-color: var(--bg-color); color: var(--text-color); font-family: 'Inter', sans-serif;
            display: flex; justify-content: center; align-items: center; min-height: 100vh;
            padding: 2rem; transition: background 0.3s, color 0.3s;
            /* Hide content until loaded to be extra safe */
            opacity: 0; animation: fadeIn 0.5s forwards;
        }
        @keyframes fadeIn { to { opacity: 1; } }

        .container {
            background: var(--glass-bg); backdrop-filter: blur(12px); padding: 2.5rem;
            border-radius: 24px; box-shadow: var(--shadow); border: 1px solid var(--glass-border);
            display: flex; flex-direction: column !important; gap: 1.5rem;
            width: 100%; max-width: 600px; margin: 0 auto;
        }

        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        h1 { font-weight: 800; font-size: 1.5rem; }
        .dot { color: var(--primary); }

        /* CONTROLS */
        .controls-row { display: flex; justify-content: space-between; align-items: center; width: 100%; flex-wrap: wrap; gap: 1rem; }
        .stats-bar { display: flex; gap: 1rem; flex-wrap: wrap; }
        .stat-item { display: flex; flex-direction: column; align-items: center; }
        .stat-item small { font-size: 0.7rem; color: var(--gray-text); text-transform: uppercase; }
        .stat-item span { font-size: 1.2rem; font-weight: 700; color: var(--primary); }

        /* GAME AREA */
        .game-wrapper { width: 100%; }
        .quote-display { font-family: 'JetBrains Mono', monospace; font-size: 1.1rem; line-height: 1.6; margin-bottom: 1rem; color: var(--gray-text); min-height: 50px; }
        .quote-input {
            width: 100%; height: 100px; padding: 1rem; border: 2px solid var(--input-border);
            border-radius: 12px; background: var(--input-bg); color: var(--text-color);
            font-family: 'JetBrains Mono', monospace; font-size: 1rem; resize: none; outline: none;
        }
        .quote-input:focus { border-color: var(--primary); }

        /* KEYBOARD */
        .keyboard { display: flex; flex-direction: column; align-items: center; gap: 6px; margin-top: 1rem; user-select: none; }
        .row { display: flex; gap: 6px; }
        .key {
            width: 32px; height: 36px; background: var(--input-bg); border: 1px solid var(--input-border);
            border-radius: 6px; display: flex; justify-content: center; align-items: center;
            font-size: 0.8rem; font-weight: 600; color: var(--gray-text); box-shadow: 0 2px 0 var(--input-border); transition: all 0.1s;
        }
        .space { width: 180px; }
        .key.active { background: var(--primary); color: white; border-color: var(--primary-dark); box-shadow: 0 0 0 var(--primary-dark); transform: translateY(2px); }
        .key.error { background: var(--red); color: white; border-color: #b91c1c; box-shadow: 0 0 0 #b91c1c; transform: translateY(2px); }

        /* CHART */
        .chart-container { width: 100%; padding: 1rem; background: rgba(128,128,128, 0.05); border-radius: 16px; margin-top: 1rem; }
        canvas { width: 100% !important; height: 200px !important; }

        /* BUTTONS */
        .restart-btn { width: 100%; padding: 1rem; background: var(--primary); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; margin-top: 1rem; }
        .restart-btn:hover { background: var(--primary-dark); }

        /* UTILS */
        .hidden { display: none !important; }
        .correct { color: var(--text-color); }
        .incorrect { color: var(--red); text-decoration: underline wavy var(--red); }
        .shake { animation: shake 0.3s ease; border-color: var(--red); }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-5px);} 75% {transform: translateX(5px);} }
        footer { text-align: center; margin-top: 2rem; color: var(--gray-text); font-size: 0.8rem; }
        .theme-btn { background: none; border: none; cursor: pointer; color: var(--text-color); }
        .logout-btn { background:none; border:1px solid var(--input-border); padding:0.3rem 0.8rem; border-radius:6px; cursor:pointer; color:var(--text-color); margin-left:10px;}

        /* MOBILE RESPONSIVE */
        @media (max-width: 768px) {
            .keyboard { display: none; }
            .quote-input { height: 80px; font-size: 1rem; }
            .container { padding: 1.5rem; width: 95%; }
            .background-blob { display: none; }
        }
    </style>
</head>
<body>

    <div class="background-blob" style="position:fixed; top:-10%; right:-10%; width:600px; height:600px; background:linear-gradient(135deg, #6366f1, #a855f7); border-radius:50%; filter:blur(100px); opacity:0.3; z-index:-1;"></div>

    <div class="container">
        <header>
            <div class="brand">
                <h1>TypeMaster<span class="dot">.</span></h1>
            </div>
            
            <div class="user-display" style="display:flex; align-items:center;">
                <button id="theme-toggle" class="theme-btn">
                    <svg id="sun-icon" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                    <svg id="moon-icon" style="display: none;" width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
                </button>
                <div style="margin-left: 1rem; text-align:right;">
                    <strong id="display-username" style="color: var(--primary);">User</strong>
                </div>
                <button id="logout-btn" class="logout-btn">Logout</button>
            </div>
        </header>

        <div class="controls-row">
            <div style="display:flex; gap:1rem;">
                <div>
                    <label for="level-select" style="font-size:0.8rem; color:var(--gray-text);">Level:</label>
                    <select id="level-select" style="padding:0.3rem; border-radius:6px; border:1px solid var(--input-border); background:var(--input-bg); color:var(--text-color);">
                        <option value="easy">Easy</option>
                        <option value="medium" selected>Medium</option>
                        <option value="hard">Hard</option>
                    </select>
                </div>
                <div style="display:flex; align-items:center; gap:0.3rem;" title="Game ends immediately if you make a mistake.">
                    <input type="checkbox" id="sudden-death-toggle" style="cursor: pointer;">
                    <label for="sudden-death-toggle" style="color:var(--red); font-size:0.8rem; font-weight:700; cursor: pointer;">
                        Sudden Death ðŸ’€ 
                        <span style="font-size:0.7rem; color:var(--gray-text); font-weight:400; margin-left:2px;">(Ends on 1st Mistake)</span>
                    </label>
                </div>
            </div>

            <div class="stats-bar">
                <div class="stat-item"><small>Time</small><span id="timer">0s</span></div>
                <div class="stat-item"><small>Mistakes</small><span id="mistakes" style="color:var(--red);">0</span></div>
                <div class="stat-item"><small>Accuracy</small><span id="accuracy">100%</span></div>
                <div class="stat-item"><small>WPM</small><span id="wpm">0</span></div>
                <div class="stat-item"><small>Best</small><span id="high-score">0</span></div>
            </div>
        </div>

        <div class="game-wrapper">
            <div class="quote-display" id="quote-display">Loading...</div>
            <textarea class="quote-input" id="quote-input" placeholder="Type here..." autofocus></textarea>
            <div id="feedback-msg" class="hidden" style="color:var(--red); font-size:0.8rem;">Typo! Keep going!</div>
        </div>

        <button id="restart-btn" class="restart-btn">Restart Test</button>

        <div class="keyboard">
            <div class="row"><div class="key" data-key="Q">Q</div><div class="key" data-key="W">W</div><div class="key" data-key="E">E</div><div class="key" data-key="R">R</div><div class="key" data-key="T">T</div><div class="key" data-key="Y">Y</div><div class="key" data-key="U">U</div><div class="key" data-key="I">I</div><div class="key" data-key="O">O</div><div class="key" data-key="P">P</div></div>
            <div class="row"><div class="key" data-key="A">A</div><div class="key" data-key="S">S</div><div class="key" data-key="D">D</div><div class="key" data-key="F">F</div><div class="key" data-key="G">G</div><div class="key" data-key="H">H</div><div class="key" data-key="J">J</div><div class="key" data-key="K">K</div><div class="key" data-key="L">L</div></div>
            <div class="row"><div class="key" data-key="Z">Z</div><div class="key" data-key="X">X</div><div class="key" data-key="C">C</div><div class="key" data-key="V">V</div><div class="key" data-key="B">B</div><div class="key" data-key="N">N</div><div class="key" data-key="M">M</div></div>
            <div class="row"><div class="key space" data-key=" "></div></div>
        </div>

        <div class="chart-container">
            <h3>Recent Progress</h3>
            <canvas id="progressChart"></canvas>
        </div>

        <footer>
            Created by <strong style="color: var(--primary);">Jayanti Jha</strong> | &copy; 2025
        </footer>
    </div>

    <script src="script.js"></script>
</body>
</html>